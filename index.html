<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Rekap Kas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #fff;
      --fg: #222;
      --accent: #2a6;
      --table-head: #eee;
      --table-border: #ccc;
      --summary-bg: #f6f6f6;
      --btn-bg: #f1f1f1;
      --btn-fg: #222;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #181a20;
        --fg: #eee;
        --accent: #48ff94;
        --table-head: #25262b;
        --table-border: #444;
        --summary-bg: #23242b;
        --btn-bg: #25262b;
        --btn-fg: #eee;
      }
    }
    html[data-theme="dark"] {
      --bg: #181a20;
      --fg: #eee;
      --accent: #48ff94;
      --table-head: #25262b;
      --table-border: #444;
      --summary-bg: #23242b;
      --btn-bg: #25262b;
      --btn-fg: #eee;
    }
    html[data-theme="light"] {
      --bg: #fff;
      --fg: #222;
      --accent: #2a6;
      --table-head: #eee;
      --table-border: #ccc;
      --summary-bg: #f6f6f6;
      --btn-bg: #f1f1f1;
      --btn-fg: #222;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 1em;
      background: var(--bg);
      color: var(--fg);
      transition: background 0.2s, color 0.2s;
    }
    h1 { font-size: 1.3em; margin-bottom: 0.5em; }
    .filters, .summary, .pagination { 
      display: flex; flex-wrap: wrap; gap: 1em; align-items: center; 
      margin-bottom: 1em; 
    }
    .filters label, .pagination label { font-weight: bold; margin-right: 0.5em; }
    .summary { background: var(--summary-bg); border-radius: 8px; padding: 1em; gap: 2em; }
    .summary-item { font-size: 1.1em; }
    .saldo { font-weight: bold; color: var(--accent); }
    table { border-collapse: collapse; width: 100%; font-size: 0.95em; background: var(--bg); }
    th, td { border: 1px solid var(--table-border); padding: 0.5em; text-align: left; }
    th { background: var(--table-head); color: var(--fg); }
    .pagination button { padding: 0.4em 1em; font-size: 1em; background: var(--btn-bg); color: var(--btn-fg); border: 1px solid var(--table-border); border-radius: 4px; cursor: pointer; }
    .pagination select, .filters select, .filters input { padding: 0.3em 0.5em; font-size: 1em; background: var(--bg); color: var(--fg); border: 1px solid var(--table-border); border-radius: 4px;}
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .table-wrapper { overflow-x: auto; }
    /* Floating icon group */
    .floating-icons {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      display: flex;
      gap: 8px;
    }
    table tr:nth-child(even) td {
      background: #f9f9f9;
    }
    html[data-theme="dark"] table tr:nth-child(even) td {
      background: #23242b;
    }
    #loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      font-size: 1.2em;
      color: var(--accent);
      font-weight: bold;
      background: var(--summary-bg);
      border-radius: 8px;
      margin-bottom: 2em;
      letter-spacing: 1px;
    }
    .icon-btn {
      width: 40px;
      height: 40px;
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: 1px solid var(--table-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4em;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      transition: background 0.2s, color 0.2s, box-shadow 0.2s;
      outline: none;
    }
    .icon-btn:active {
      background: var(--accent);
      color: var(--bg);
      box-shadow: 0 1px 4px rgba(0,0,0,0.13);
    }
    @media (max-width: 600px) {
      .filters, .summary, .pagination { flex-direction: column; align-items: stretch; gap: 0.5em; }
      table, th, td { font-size: 0.87em; }
      th, td { padding: 0.35em; }
      .summary { gap: 1em; padding: 0.6em; }
      .summary-item { font-size: 1em; }
      .pagination button, .pagination select { font-size: 0.95em; }
      .floating-icons { top: 10px; right: 10px; gap: 4px; }
      .icon-btn { width: 34px; height: 34px; font-size: 1.15em; }
      #loading { min-height: 100px; font-size: 1em; }
    }
    /* Print styles */
    @media print {
      body { background: #fff !important; color: #222 !important; }
      .floating-icons, .filters, .pagination, #loading { display: none !important; }
      .summary { background: #fff !important; color: #222 !important; border: none !important; }
      .table-wrapper { overflow: visible !important; }
      table { font-size: 1em !important;}
      th, td { border: 1px solid #222 !important; color: #222 !important; background: #fff !important; }
    }
  </style>
</head>
<body>
  <div class="floating-icons">
    <button id="dark-toggle" class="icon-btn" title="Dark/Light Mode" aria-label="Toggle Dark Mode">üåô</button>
    <button id="print-btn" class="icon-btn" title="Print" aria-label="Print">üñ®Ô∏è</button>
  </div>
  <h1>Rekap Kas</h1>
  <div class="filters" id="filters" style="display:none;">
    <div>
      <label for="kategori">Kategori:</label>
      <select id="kategori">
        <option value="">Semua</option>
      </select>
    </div>
    <div>
      <label for="keterangan">Keterangan:</label>
      <input type="text" id="keterangan" placeholder="Ketik kata...">
    </div>
  </div>
  <div class="summary" id="summary" style="display:none;">
    <div class="summary-item" id="total-pemasukan"></div>
    <div class="summary-item" id="total-pengeluaran"></div>
    <div class="summary-item saldo" id="saldo"></div>
  </div>
  <div id="loading">Mengambil data...</div>
  <div class="table-wrapper">
    <table id="data-table" style="display:none;">
      <thead id="table-head"></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
  <div class="pagination" id="pagination" style="display:none;">
    <button id="prev-btn">Sebelumnya</button>
    <span id="page-info"></span>
    <button id="next-btn">Berikutnya</button>
    <label for="per-page">Baris per halaman:</label>
    <select id="per-page">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="25">25</option>
      <option value="50">50</option>
    </select>
  </div>
  <script>
    // Dark mode toggle
    const darkToggle = document.getElementById('dark-toggle');
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      darkToggle.innerText = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      darkToggle.title = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
    }
    // Initial theme
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved) setTheme(saved);
      else if (window.matchMedia('(prefers-color-scheme: dark)').matches) setTheme('dark');
      else setTheme('light');
    })();
    darkToggle.onclick = function() {
      const curr = document.documentElement.getAttribute('data-theme');
      setTheme(curr === 'dark' ? 'light' : 'dark');
    };

    // Print button - cetak semua hasil filter, bukan hanya halaman aktif
    document.getElementById('print-btn').onclick = function() {
      const oldPage = currentPage;
      const oldPerPage = perPage;
      perPage = filteredRows.length || 9999;
      currentPage = 1;
      renderTable();
      window.print();
      perPage = oldPerPage;
      currentPage = oldPage;
      renderTable();
    };

    // Main logic
    const apiUrl = 'https://script.google.com/macros/s/AKfycbz_32y36zrXtUCFt9_9J0zAxigngH5Rx5lrWJ8qvwve_34MjjFTCf4Xs74SY-sEP6Bw/exec';
    let headers = [];
    let rows = [];
    let kategoriList = [];
    let filteredRows = [];
    let currentPage = 1;
    let perPage = 10;

    function parseTanggal(str) {
      // Format: dd/mm/yyyy atau d/m/yyyy
      if (!str) return 0;
      const parts = str.split('/');
      if (parts.length !== 3) return 0;
      const [dd, mm, yyyy] = parts;
      // new Date(year, month-1, day)
      const date = new Date(Number(yyyy), Number(mm)-1, Number(dd));
      return date.getTime() || 0;
    }

    function renderTable() {
      const table = document.getElementById('data-table');
      const tbody = document.getElementById('table-body');
      table.style.display = '';

      // Pagination
      const totalRows = filteredRows.length;
      const totalPages = Math.max(1, Math.ceil(totalRows / perPage));
      currentPage = Math.min(currentPage, totalPages);
      const start = (currentPage - 1) * perPage;
      const end = start + perPage;
      const pagedRows = filteredRows.slice(start, end);

      // Isi tabel
      tbody.innerHTML = pagedRows.map(row =>
        '<tr>' + row.map(cell => `<td>${cell ?? ''}</td>`).join('') + '</tr>'
      ).join('');

      // Ambil index kolom
      const idxPemasukan = headers.findIndex(h => h.toUpperCase() === 'PEMASUKAN');
      const idxPengeluaran = headers.findIndex(h => h.toUpperCase() === 'PENGELUARAN');

      let totalPemasukan = 0, totalPengeluaran = 0;
      filteredRows.forEach(row => {
        const pemasukan = parseFloat(row[idxPemasukan]) || 0;
        const pengeluaran = parseFloat(row[idxPengeluaran]) || 0;
        totalPemasukan += pemasukan;
        totalPengeluaran += pengeluaran;
      });
      const saldo = totalPemasukan - totalPengeluaran;

      // Tampilkan summary
      document.getElementById('summary').style.display = '';
      document.getElementById('total-pemasukan').innerText = "Pemasukan: Rp " + totalPemasukan.toLocaleString();
      document.getElementById('total-pengeluaran').innerText = "Pengeluaran: Rp " + totalPengeluaran.toLocaleString();
      document.getElementById('saldo').innerText = "Saldo: Rp " + saldo.toLocaleString();

      // Pagination UI
      const pagination = document.getElementById('pagination');
      pagination.style.display = totalRows > perPage ? '' : 'none';
      document.getElementById('page-info').innerText = `Halaman ${currentPage} dari ${totalPages}`;
      document.getElementById('prev-btn').disabled = currentPage === 1;
      document.getElementById('next-btn').disabled = currentPage === totalPages;
    }

    function applyFilter() {
      const kategoriVal = document.getElementById('kategori').value;
      const keteranganVal = document.getElementById('keterangan').value.trim().toLowerCase();
      const idxKategori = headers.findIndex(h => h.toUpperCase() === 'KATEGORI');
      const idxKeterangan = headers.findIndex(h => h.toUpperCase() === 'KETERANGAN');

      filteredRows = rows.filter(row => {
        let matchKategori = !kategoriVal || row[idxKategori] === kategoriVal;
        let matchKeterangan = !keteranganVal || (row[idxKeterangan] && row[idxKeterangan].toLowerCase().includes(keteranganVal));
        return matchKategori && matchKeterangan;
      });
      currentPage = 1;
      renderTable();
    }

    fetch(apiUrl)
      .then(response => response.json())
      .then(rawData => {
        document.getElementById('loading').style.display = 'none';

        [headers, ...rows] = rawData;
        // Urutkan rows berdasarkan tanggal (terbaru di awal)
        const idxTanggal = headers.findIndex(h => h.toUpperCase() === 'TANGGAL');
        rows.sort((a, b) => parseTanggal(b[idxTanggal]) - parseTanggal(a[idxTanggal]));
        // Header tabel
        document.getElementById('table-head').innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
        // Inisialisasi kategori unik
        const idxKategori = headers.findIndex(h => h.toUpperCase() === 'KATEGORI');
        kategoriList = [...new Set(rows.map(row => row[idxKategori]).filter(Boolean))];
        // Isi dropdown kategori
        const kategoriSelect = document.getElementById('kategori');
        kategoriList.forEach(kat => {
          const opt = document.createElement('option');
          opt.value = kat;
          opt.textContent = kat;
          kategoriSelect.appendChild(opt);
        });
        document.getElementById('filters').style.display = '';

        // Event filter
        kategoriSelect.onchange = applyFilter;
        document.getElementById('keterangan').oninput = applyFilter;

        // Pagination events
        document.getElementById('prev-btn').onclick = function() {
          if (currentPage > 1) {
            currentPage--;
            renderTable();
          }
        };
        document.getElementById('next-btn').onclick = function() {
          const totalRows = filteredRows.length;
          const totalPages = Math.max(1, Math.ceil(totalRows / perPage));
          if (currentPage < totalPages) {
            currentPage++;
            renderTable();
          }
        };
        document.getElementById('per-page').onchange = function(e) {
          perPage = parseInt(e.target.value, 10);
          currentPage = 1;
          renderTable();
        };

        // Tampilkan semua data awal
        filteredRows = rows;
        renderTable();
      })
      .catch(err => {
        document.getElementById('loading').innerText = 'Gagal mengambil data: ' + err;
      });
  </script>
</body>
</html>